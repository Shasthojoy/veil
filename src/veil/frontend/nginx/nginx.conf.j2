user {{ config.owner }} {{ config.owner_group }};
# uncomment this if you are not running nginx under supervisord
daemon off;
worker_processes {{ config.get('worker_processes_count', 'auto') }};
{% if 'worker_priority' in config %}
worker_priority config.worker_priority;
{% endif %}
{% if 'worker_rlimit_nofile' in config %}
# Maximum open file descriptors per process; should be > worker_connections.
worker_rlimit_nofile config.worker_rlimit_nofile;
{% endif %}

{% if 'pid_file' in config %}
pid {{ config.pid_file }};
{% endif %}

events {
    worker_connections {{ config.get('connections_count_per_worker', 100) }};
    multi_accept on;
    use epoll;
}

http {
    server_tokens off;
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    keepalive_timeout 30;
    client_header_timeout 20;
    client_body_timeout 20;
    send_timeout 20;
    reset_timedout_connection on;

    client_body_buffer_size 128k;
    client_max_body_size 10m;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:AES128:AES256:RC4-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    {% if config.enable_compression %}
        gzip on;
        # Enable compression both for HTTP/1.0 and HTTP/1.1 (required for CloudFront).
        gzip_http_version 1.0;
        gzip_static off;
        gzip_proxied any;
        gzip_min_length 256;
        gzip_comp_level 5;
        gzip_types text/plain text/css text/javascript application/javascript application/x-javascript application/json text/x-json text/xml application/xml application/xml+rss application/atom+xml image/x-icon image/bmp image/x-ms-bmp;
        gzip_vary on;
        gzip_buffers 64 8k;
        gzip_disable "msie6";
    {% else %}
        gzip off;
        gzip_static off;
    {% endif %}

    open_file_cache max=65000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    proxy_http_version 1.1;
    proxy_read_timeout 200;
    proxy_buffers 256 8k;
    proxy_intercept_errors on;
    proxy_pass_request_headers on;
    proxy_set_header Host $host;
    proxy_set_header Accept-Encoding "";
    {% if not config.has_bunker or config.is_bunker %}
    proxy_set_header X-Real-IP $remote_addr;
    {% else %}
    set_real_ip_from {{ config.bunker_ip }};
    real_ip_header X-Real-IP;
    real_ip_recursive on;
    {% endif %}
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Request-Code $msec-$cookie_vbcode;
    proxy_redirect off;
    # Only retry if there was a communication error, not a timeout
    # on the Tornado server (to avoid propagating "queries of death"
    # to all frontends)
    proxy_next_upstream error;

    access_log off;
    log_format logstash_json '{ "@timestamp": "$time_iso8601", '
                             '"@type": "nginx", '
                             '"@fields": { '
                             '"user_code": "$cookie_vucode", '
                             '"browser_code": "$cookie_vbcode", '
                             '"remote_addr": "$remote_addr", '
                             '"request": "$request", '
                             '"request_time": "$request_time", '
                             '"request_code": "$msec-$cookie_vbcode", '
                             '"request_method": "$request_method", '
                             '"status": "$status", '
                             '"body_bytes_sent": "$body_bytes_sent", '
                             '"http_referrer": "$http_referer", '
                             '"http_user_agent": "$http_user_agent", '
                             '"http_x_forwarded_for": "$http_x_forwarded_for" } }';

    {% for server_properties in config.servers.values() %}
        {% for upstream_name, upstream_servers in (server_properties.get('upstreams') or {}).items() %}
        upstream {{ upstream_name }} {
            {% for upstream_server in upstream_servers %}
            server {{ upstream_server.host }}:{{ upstream_server.port }};
            {% endfor %}
        }
        {% endfor %}
    {% endfor %}

    {% for server_name, server_properties in config.servers.items() %}
    server {
        server_name  {{ server_name }};
        error_log {{ config.log_directory }}/{{ server_name }}-error.log;
        {% if not config.has_bunker or config.is_bunker %}
        access_log {{ config.log_directory }}/{{ server_name }}-access.log logstash_json;
        {% else %}
        access_log off;
        {% endif %}
        {% for key, value in server_properties.items() %}
            {% if 'locations' == key %}
                {% for location, location_properties in value.items() %}
                location {{ location }} {
                    {% for key, value in location_properties.items() %}
                        {% if '_' == key %}
                            {{ value }}
                        {% else %}
                            {{ key }} {{ value }};
                        {% endif %}
                    {% endfor %}
                }
                {% endfor %}
            {% elif 'upstreams' == key %}
                {# skip this #}
            {% elif 'error_page_dir' == key %}
                {# skip #}
            {% elif 'error_page' == key %}
                {% if value %}
                    {% for error_number, error_page_name in value.items() %}
                        error_page {{ error_number }} /{{ error_page_name }};
                        location = /{{ error_page_name }} {
                            root {{ server_properties['error_page_dir'] }};
                            }
                    {% endfor %}
                {% endif %}
            {% else %}
                {{ key }} {{ value }};
            {% endif %}
        {% endfor %}
    }
    {% endfor %}
}